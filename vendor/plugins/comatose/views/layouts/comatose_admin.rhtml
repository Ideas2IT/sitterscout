<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html class="noscript" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=<%= Comatose.config.content_type %>"/>
    <title>Comatose Admin</title>
    <style>
BODY {
  background: #DDD;
  margin: 0px 100px;
  padding: 0px;
  font-family: "Lucida Grande", Tahoma, Verdana, Arial, Sans-Serif;
  font-size: 12px;
  min-width: 450px;
}
/* General Layout and Header Area */
#page-container {
  margin: 0px;
  padding: 0px;
}
#header {
  background: #0053C2;
  padding: 5px;
  border-bottom: 4px solid #00398B;
}
#header A {
  text-decoration: none;
  color: white;
}
#header A:hover {
  color: white;
}
#header h1 {
  margin: 0px;
  padding: 0px;
  padding-left: 10px;
}
#header h5 {
  margin: 0px;
  padding: 0px;
  padding-left: 15px;
  color: silver;
}
#header #flash {
  float: right;
  color: #4BA8FF;
  font-weight: bold;
  margin-right: 5px;
}
/* Content Area */
#content {
  padding: 15px;
  background: white;
  border-left: 1px solid silver;
  border-right: 1px solid silver;
}
#content h1 {
  margin: 0px;
  padding: 0px;
  font-size: 135%;
  color: gray;
}
#content .action {
  float: right;
  color: gray;
}
#content .action A {
  font-weight: bold;
  text-decoration: none;
  color: darkgreen;
  border-bottom: 1px solid black;
}
#content .action A:hover {
  color: red;
  border-bottom: 1px solid red;
}
#content .page-header {
  color: gray;
}

/* Page Listing */
#content .tree-controller {
  border: 0px;
  cursor: pointer;
}
#content .page-list.root {
  clear: both;
  list-style: none;
  margin: 0px;
  padding: 0px;
  margin-top: 10px;
}
#content .page-list.collapsed {
  display: none;
}
#content .page-list {
  background: white;
  clear: both;
  list-style: none;
  border-left: 0px dotted silver;
  margin: 0px;
  padding: 0px;
  padding-left: 15px;
  margin-top: 2px;
}
#content .page-list LI {
  clear: both;
  padding: 0px;
  margin: 5px 0px;
  padding-top: 2px;
  padding-right: 0px;
  padding-left: 2px;
}
#content .page-list .commands {
  font-size: 90%;
  padding-left: 5px;
  color: silver;
}
#content .page-list .commands A {
  color: gray;
}
#content .page-list .commands A.add-page:hover {
  color: blue;
}
#content .page-list .commands A.reorder-children:hover {
  color: black;
}
#content .page-list .commands A.delete-page:hover {
  color: white;
}
#content .page-list .commands A.reordering {
  background: navy;
  color: white;
}
#content .page-list .commands A.reordering:hover {
  color: white;
}
#content .page-list A.page {
  text-decoration: none;
  color: black;
  margin-left: 3px;
  font-size: 150%;
  display: block;
}
#content .page-list A.page:hover {
  /*color: blue;*/
  background: white url(../images/comatose/title-hover-bg.gif) top left repeat-y;
}
#content .handle, #content .do-reorder UL LI .handle {
  display: none;
}

#content .page-list .hover {
  background: #F1F0DB;
}
#content .page-list .hover-delete {
  background: red;
  color: #FF8E90;
}
#content .page-list .hover-delete A,
#content .page-list .hover-delete .commands A {
  color: #FF8E90;
}
#content .page-list .hover-delete A.page {
  color: white;
  border-bottom: 0px;
}
#content .page-list .hover-delete UL LI A.page {
  color: red;
  border-bottom: 0px;
}

#content .do-reorder LI .handle {
  display: inline;
  background: gray;
  color: white;
  padding: 1px 3px;
  cursor: move;
}

#content .page-list .do-reorder .commands A {
  display: none;
}

/* Page Form */
#content .page-form {
  margin-top: 10px;
}
#content .page-form LABEL {
  font-weight: bold;
  color: #555;
}
#content .page-form .meta-info LABEL {
  color: #999 !important;
}
#content .page-form .label { 
  padding-top: 5px;
  width: 75px;
  text-align: right;
  padding-right: 10px;
}
#content .page-form .label.body {
  vertical-align: top;
  padding-top: 10px;
} 
#content .page-form .field { 
  padding-top: 5px;  
}
#content .page-form .field-help { 
  color: gray;
}
#content .page-form #page_title {
  font-size: 125%;
  font-weight: bold;
}
#content .page-form #page_slug {
  color: gray;
}
#content .page-form #page_body {
  font-family: monospace;
  font-size: 110%;
}
#content #button-group {
  padding: 10px;
  text-align: right;
  background-color: #EAEAEA;
  margin-top: 10px;
}
#content #button-group .last-update {
  float: left;
  color: gray;
  padding-top: 4px;
  font-weight: bold;
}
#content #button-group .last-update LABEL {
  font-weight: normal;
}
#content #button-group .last-update A {
  color: gray;
}
#content #button-group A {
  color: maroon;
}
#content #button-group A:hover {
  color: red;
}
#content #preview-area {
  margin-top: 10px;
}
#content #preview-area FIELDSET {
  border: 1px solid silver;
}
#content #preview-area LEGEND {
  font-size: 125%;
}
#content #preview-area .preview-body {
  padding: 10px;
}
#content #preview-area .preview-note {
  background: #FFFFD9;
  padding: 15px;
}
#content #preview-area .commands {
  text-align: right;
  color: gray;
}
#content #preview-area .commands A{
  color: gray;
}
#content #preview-area .commands A:hover{
  color: black;
}
#content .revisions {
  padding: 10px;
  width: 49%; 
}
#content .current-content {
}
#content .older-content {
  background: #E9E9E9;
  float: right;
}

#content .revisions label {
  display: block;
  color: #000;
}
#content .revisions label span {
  color: #999;
  font-weight: normal !important;
}
#content .revisions .title {
  font-weight: bold;
  margin-top: 5px;
}
#content .revisions .header {
  font-size: 110%;
  vertical-align: middle;
  font-weight: bold;
}
#content .revisions .header-actions {
  float: right;
  font-size: 90%;
  font-weight: normal;
  color: #999;
}
#content .revisions .meta {
  margin-bottom: 15px;
}
#content .revisions .footer {
  margin-top: 25px !important;
  text-align: center !important;
}
#content #go-btn {
  display: none;
}
/* Errors */
#errorExplanation {
  border: 1px solid red;
  background: #FFEAEB;
  padding: 10px;
  margin-top: 10px;
}
#errorExplanation h2 {
  margin: 0px;
  padding: 0px;
  color: maroon;
}
#errorExplanation p {
  margin: 0px;
  padding: 0px;
  padding-top: 5px;
  padding-left: 15px;
}
#errorExplanation ul {  
  margin: 0px;
  padding: 0px;
  padding-left: 35px;
}
#errorExplanation li {
  margin: 0px;
  padding: 0px;  
  padding-top: 5px;
}
/* Footer Area*/
#footer {
  border-top: 4px solid #AAA;
  text-align: center;
  font-size: 90%;
  color: #AAA;
  padding-top: 5px;
  padding-bottom: 5px;
}
#footer A {
  color: #AAA;
  text-decoration: none;
  font-weight: bold;
}
#footer A:hover {
  color: #333;
  text-decoration: underline;
}

/* Modifiers */

/* When JavaScript is Turned Off... We need to adjust some things... */
.noscript #more-options,
.noscript #preview-area,
.noscript #preview-btn,
.noscript .tree-controller {
  display: none;
}
.noscript .page-list.collapsed {
  display: block !important;
}
.noscript .delete-page:hover {
  color: red !important;
}
.noscript #content .page-form #page_title,
.noscript #content .page-form #page_slug,
.noscript #content .page-form #page_parent,
.noscript #content .page-form #page_keywords,
.noscript #content .page-form #page_body {
  width: 100% !important;
}
.noscript #content .revisions #go-btn {
  display: inline;
}

</style>
    <%= javascript_include_tag :defaults %>
    <script>
// CSS Browser Selector   v0.2.3b (M@: added noscript support)
// Documentation:         http://rafael.adm.br/css_browser_selector
// License:               http://creativecommons.org/licenses/by/2.5/
// Author:                Rafael Lima (http://rafael.adm.br)
// Contributors:          http://rafael.adm.br/css_browser_selector#contributors
var css_browser_selector = function() {
  var 
    ua = navigator.userAgent.toLowerCase(),
    is = function(t){ return ua.indexOf(t) != -1; },
    h = document.getElementsByTagName('html')[0],
    b = (!(/opera|webtv/i.test(ua)) && /msie (\d)/.test(ua)) ? ((is('mac') ? 'ieMac ' : '') + 'ie ie' + RegExp.$1)
      : is('gecko/') ? 'gecko' : is('opera') ? 'opera' : is('konqueror') ? 'konqueror' : is('applewebkit/') ? 'webkit safari' : is('mozilla/') ? 'gecko' : '',
    os = (is('x11') || is('linux')) ? ' linux' : is('mac') ? ' mac' : is('win') ? ' win' : '';
  var c = b+os+' js'; 
  h.className = h.className.replace('noscript', '') + h.className?' '+c:c;
}();

// List View Functions
var ComatoseList = {
  save_node_state: true,
  state_store: 'cookie', // Only 'cookie' for now
  state_key: 'ComatoseTreeState',

  init: function() {
    var items = ComatoseList._read_state();
    items.each(function(node){
      ComatoseList.expand_node(node.replace('page_controller_', ''))
    });
  },
  
  toggle_tree_nodes : function(img, id) {
    if(/expanded/.test(img.src)) {
      $('page_list_'+ id).addClassName('collapsed');
      img.src = img.src.replace(/expanded/, 'collapsed')
      if(ComatoseList.save_node_state) {
        var items = ComatoseList._read_state();
        items = items.select(function(id){ return id != img.id; })
        ComatoseList._write_state(items);
      }
    } else {
      $('page_list_'+ id).removeClassName('collapsed');
      img.src = img.src.replace(/collapsed/, 'expanded')
      if(ComatoseList.save_node_state) {
        var items = ComatoseList._read_state();
        items.push(img.id);
        ComatoseList._write_state(items);
      }
    }
  },
  
  expand_node: function(id) {
    $('page_list_'+ id).removeClassName('collapsed');
    $('page_controller_'+ id).src = $('page_controller_'+ id).src.replace(/collapsed/, 'expanded')    
  },
  
  collapse_node: function(id) {
    $('page_list_'+ id).addClassName('collapsed');
    $('page_controller_'+ id).src = $('page_controller_'+ id).src.replace(/expanded/, 'collapsed')    
  },
  
  item_hover : function(node, state, is_delete) {
    if( state == 'over') {
      $(node).addClassName( (is_delete) ? 'hover-delete' : 'hover' );
    } else {
      $(node).removeClassName( (is_delete) ? 'hover-delete' : 'hover' );
    }
  },
  
  toggle_reorder: function(node, anc, id) {
    if( $(node).hasClassName('do-reorder') ) {
      $(node).removeClassName( 'do-reorder' );
      $(anc).removeClassName('reordering');
      $(anc).innerHTML = "reorder children";
    } else {
      $(node).addClassName( 'do-reorder' );
      $(anc).addClassName('reordering');
      $(anc).innerHTML = "finished reordering";
      // Make sure the children are visible...
      ComatoseList.expand_node(id);
    }
  },
  
  _write_state: function(items) {
    var cookie = {}; var options = {}; var expiration = new Date();
    cookie[ ComatoseList.state_key ] = items.join(',');
    expiration.setDate(expiration.getDate()+30)
    options['expires'] = expiration;
    Cookie.write( cookie, options );
  },
  
  _read_state: function() {
    var state = Cookie.read( ComatoseList.state_key );
    return (state != "" && state != null) ? state.split(',') : [];
  }
}

// Edit Form Functions
var ComatoseEditForm = {

  default_data: {},
  last_preview: {},
  last_title_slug: '',
  mode : null,
  liquid_horiz: true,
  width_offset: 325,

  // Initialize the page...
  init : function(mode) {
    this.mode = mode;
    this.default_data = Form.serialize(document.forms[0]);
    if(mode == 'new') {
      this.last_title_slug = $('page_title').value.toSlug();
      Event.observe('page_title', 'blur', ComatoseEditForm.title_updated_aggressive);
    } else {
      Event.observe('page_title', 'blur', ComatoseEditForm.title_updated);
    }
    $('page_title').focus();
    Hide.these(
      'preview-area',
      'slug_row',
      'parent_row',
      'keywords_row',
      'filter_row',
      'created_row'
    );
    $('page_title').select();
    // Create the horizontal liquidity of the fields
    if(this.liquid_horiz) {
      xOffset = this.width_offset;
      new Layout.LiquidHoriz((xOffset + 50), 'page_title');
      new Layout.LiquidHoriz(xOffset, 'page_slug','page_keywords','page_parent','page_body');
    }
  },
  // For use when updating an existing page...
  title_updated : function() {
    slug = $('page_slug');
    if(slug.value == "") {
      title = $('page_title');
      slug.value = title.value.toSlug();
    }
  },
  // For use when creating a new page...
  title_updated_aggressive : function() {
    slug = $('page_slug');
    title = $('page_title');
    if(slug.value == "" || slug.value == this.last_title ) {
      slug.value = title.value.toSlug();
    }
    this.last_title = slug.value;
  },
  // Todo: Make the meta fields remember their visibility?
  toggle_extra_fields : function(anchor) {
    if(anchor.innerHTML == "More...") {
      Show.these(
        'slug_row',
        'keywords_row',
        'parent_row',
        'filter_row',
        'created_row'
      );
      anchor.innerHTML = 'Less...';
    } else {
      Hide.these(
        'slug_row',
        'keywords_row',
        'parent_row',
        'filter_row',
        'created_row'
      );
      anchor.innerHTML = 'More...';
    }
  },
  // Uses server to create preview of content...
  preview_content : function(preview_url) {
    $('preview-area').show();
    var params = Form.serialize(document.forms[0]);
    if( params != this.last_preview ) {
      $('preview-panel').innerHTML = "<span style='color:blue;'>Loading Preview...</span>";
      new Ajax.Updater(
         'preview-panel',
         preview_url,
         { parameters: params }
      );
    }
    this.last_preview = params;
  },
  cancel : function(url) {
    var current_data = Form.serialize(document.forms[0]);
    var data_changed = (this.default_data != current_data) 
    if(data_changed) {
      if( confirm('Changes detected. You will lose all the updates you have made if you proceed...') ) {
        location.href = url;
      }
    } else {
      location.href = url;      
    }
    
  }
}

var Hide = {
  these : function() {
    for (var i = 0; i < arguments.length; i++) {
      try {
        $(arguments[i]).hide();
      } catch (e) {}
    }
  }
}

var Show = {
  these : function() {
    for (var i = 0; i < arguments.length; i++) {
      try {
        $(arguments[i]).show();
      } catch (e) {}
    }
  }
}

// Layout namespace
var Layout = {};

// This class allows dom objects to stretch with the browser 
// (for when a good, cross-browser, CSS approach can't be found)
Layout.LiquidBase = Class.create();
// Base class for all Liquid* layouts...
Object.extend(Layout.LiquidBase.prototype, {
  enabled: true,
  elems: [],
  offset: null,
  // Constructor is (offset, **array_of_elements)
  initialize: function() {
    args = $A(arguments)
    this.offset = args.shift();
    this.elems = args.select( function(elem){ return ($(elem) != null) } );
    if( this.elems.length > 0 ) {
      this.on_resize(); // Initial size
      Event.observe(window, 'resize', this.on_resize.bind(this) );
      Event.observe(window, 'load', this.on_resize.bind(this) );
    }
  },
  resize_in: function(timeout) {
    setTimeout( this.on_resize.bind(this), timeout );
  },
  on_resize: function() {       
    // Need to override!
    alert('Override on_resize, please!');
  }
});


// Liquid vertical layout
Layout.LiquidVert = Class.create();
Object.extend(Layout.LiquidVert.prototype, Object.extend(Layout.LiquidBase.prototype, {
  on_resize: function() {       
    if( this.offset != null && this.enabled ) {
      var new_height = ((window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight) - this.offset) +"px";
      this.elems.each(function(e){ $(e).style.height = new_height; })
    }
  }
}) );


// Liquid horizontal layout
Layout.LiquidHoriz = Class.create();
Object.extend(Layout.LiquidHoriz.prototype, Object.extend(Layout.LiquidBase.prototype, {
  on_resize: function() {       
    if( this.offset != null && this.enabled ) {
      var new_width = ((window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth) - this.offset) +"px";
      this.elems.each( function(e){ $(e).style.width = new_width; })
    }
  }
}) );

// String Extensions... Yes, these are from Radiant! ;-)
Object.extend(String.prototype, {
  upcase: function() {
    return this.toUpperCase();
  },
  downcase: function() {
    return this.toLowerCase();
  },
  strip: function() {
    return this.replace(/^\s+/, '').replace(/\s+$/, '');
  },
  toInteger: function() {
    return parseInt(this);
  },
  toSlug: function() {
    // M@: Modified from Radiant's version, removes multple --'s next to each other
    // This is the same RegExp as the one on the page model...
    return this.strip().downcase().replace(/[^-a-z0-9~\s\.:;+=_]/g, '').replace(/[\s\.:;=_+]+/g, '-').replace(/[\-]{2,}/g, '-');
  }
});

// Run a spinner when an AJAX request in running...
var ComatoseAJAXSpinner = {
  busy : function () {
    if($('spinner') && Ajax.activeRequestCount > 0) {
      Effect.Appear('spinner',{duration:0.5,queue:'end'});
    }
  },

  notBusy: function() {
    if($('spinner') && Ajax.activeRequestCount == 0) {
      Effect.Fade('spinner',{duration:0.5,queue:'end'});
    }
  }  
}
// Register it with Prototype...
Ajax.Responders.register({
  onCreate: ComatoseAJAXSpinner.busy, 
  onComplete: ComatoseAJAXSpinner.notBusy
});


if(!window.Cookie)
  (function (){
    // From Mephisto!
    window.Cookie = {
      version: '0.7',
      cookies: {},
      _each: function(iterator) {
        $H(this.cookies).each(iterator);
      },
  
      getAll: function() {
        this.cookies = {};
        $A(document.cookie.split('; ')).each(function(cookie) {
          var seperator = cookie.indexOf('=');
          this.cookies[cookie.substring(0, seperator)] = 
              unescape(cookie.substring(seperator + 1, cookie.length));
        }.bind(this));
        return this.cookies;
      },
  
      read: function() {
        var cookies = $A(arguments), results = [];
        this.getAll();
        cookies.each(function(name) {
          if (this.cookies[name]) results.push(this.cookies[name]);
          else results.push(null);
        }.bind(this));
        return results.length > 1 ? results : results[0];
      },
  
      write: function(cookies, options) {
        if (cookies.constructor == Object && cookies.name) cookies = [cookies];
        if (cookies.constructor == Array) {
          $A(cookies).each(function(cookie) {
            this._write(cookie.name, cookie.value, cookie.expires,
                        cookie.path, cookie.domain);
          }.bind(this));
        } else {
          options = options || {expires: false, path: '', domain: ''};
          for (name in cookies){
            this._write(name, cookies[name],
                        options.expires, options.path, options.domain);
          }
        }
      },
  
      _write: function(name, value, expires, path, domain) {
        if (name.indexOf('=') != -1) return;
        var cookieString = name + '=' + escape(value);
        if (expires) cookieString += '; expires=' + expires.toGMTString();
        if (path) cookieString += '; path=' + path;
        if (domain) cookieString += '; domain=' + domain;
        document.cookie = cookieString;
      },
  
      erase: function(cookies) {
        var cookiesToErase = {};
        $A(arguments).each(function(cookie) {
          cookiesToErase[cookie] = '';
        });
    
        this.write(cookiesToErase, {expires: (new Date((new Date()).getTime() - 1e11))});
        this.getAll();
      },
  
      eraseAll: function() {
        this.erase.apply(this, $H(this.getAll()).keys());
      }
    };

    Object.extend(Cookie, {
      get: Cookie.read,
      set: Cookie.write,
  
      add: Cookie.read,
      remove: Cookie.erase,
      removeAll: Cookie.eraseAll,
  
      wipe: Cookie.erase,
      wipeAll: Cookie.eraseAll,
      destroy: Cookie.erase,
      destroyAll: Cookie.eraseAll
    });
  })();

</script>
  </head>
  <body>
    <div id="page-container">
      <div id="header">
        <h1><%= link_to Comatose.config.admin_title, :controller=>controller.controller_name, :action=>'index' %></h1>
        <div id="flash">
          <span id="flash-content"><%= flash[:notice] %></span>
        </div>
        <h5><%= Comatose.config.admin_sub_title %></h5>
      </div>
      <div id="content">
        <%= yield %>
      </div>
      <div id="footer">
        Powered by <a href="http://comatose.rubyforge.org" target="_new_window">Comatose <%= Comatose::VERSION %></a>, created by <a href="http://www.mattmccray.com"  target="_new_window">M@ McCray</a>.
      </div>
    </div>
  </body>
</html>
